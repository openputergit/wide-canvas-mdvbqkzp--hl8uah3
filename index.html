<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Field App</title>
    <script src="https://unpkg.com/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .neu-brutal {
            border: 3px solid #000;
            box-shadow: 5px 5px 0px #000;
            transition: all 0.2s ease;
        }
        .neu-brutal:active {
            transform: translate(5px, 5px);
            box-shadow: none;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body class="bg-[#f0f0f0] min-h-screen p-4">
    <div class="loading" id="loadingScreen">
        <div class="text-center">
            <i class="bi bi-arrow-repeat animate-spin text-4xl"></i>
            <p class="mt-2">Loading...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 neu-brutal bg-yellow-300 p-4 inline-block">Sales Field App</h1>

        <!-- Login Section -->
        <div id="loginSection" class="mb-8 neu-brutal bg-white p-6">
            <h2 class="text-2xl font-bold mb-4">Login</h2>
            <div class="mb-4">
                <input type="text" id="username" placeholder="Username" class="w-full p-2 mb-2 neu-brutal">
            </div>
            <div class="mb-4">
                <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-2 neu-brutal">
            </div>
            <button onclick="login()" class="neu-brutal bg-blue-300 p-2 w-full font-bold">Login</button>
        </div>

        <!-- Attendance Section -->
        <div id="attendanceSection" class="mb-8 neu-brutal bg-white p-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">Daily Attendance</h2>
            <div class="mb-4">
                <select id="storeSelect" class="w-full p-2 neu-brutal bg-white">
                    <option value="">Select Store</option>
                    <option value="store1">Store 1</option>
                    <option value="store2">Store 2</option>
                    <option value="store3">Store 3</option>
                </select>
            </div>
            <div class="mb-4">
                <video id="camera" class="w-full neu-brutal" autoplay></video>
                <canvas id="photoCanvas" style="display:none"></canvas>
            </div>
            <button onclick="markAttendance()" class="neu-brutal bg-green-300 p-2 w-full font-bold">Mark Attendance</button>
        </div>

        <!-- Beat Plan Section -->
        <div id="beatPlanSection" class="mb-8 neu-brutal bg-white p-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">Beat Plan</h2>
            <div id="beatPlanContainer">
                <div class="beat-plan-item mb-4">
                    <input type="text" placeholder="Location" class="w-full p-2 mb-2 neu-brutal">
                    <button class="neu-brutal bg-blue-300 p-2 w-full font-bold mb-2">Start Meeting</button>
                    <textarea placeholder="Meeting Outcome" class="w-full p-2 neu-brutal" style="display: none"></textarea>
                </div>
            </div>
            <button onclick="addBeatPlan()" class="neu-brutal bg-yellow-300 p-2 w-full font-bold">Add Location</button>
        </div>

        <!-- Order Section -->
        <div id="orderSection" class="mb-8 neu-brutal bg-white p-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">Order Entry</h2>
            <select id="orderStore" class="w-full p-2 mb-4 neu-brutal bg-white">
                <option value="">Select Store</option>
                <option value="store1">Store 1</option>
                <option value="store2">Store 2</option>
                <option value="store3">Store 3</option>
            </select>
            <div id="orderItems">
                <div class="order-item mb-4">
                    <input type="text" placeholder="Item Name" class="w-full p-2 mb-2 neu-brutal">
                    <input type="number" placeholder="Quantity" class="w-full p-2 neu-brutal">
                </div>
            </div>
            <button onclick="addOrderItem()" class="neu-brutal bg-purple-300 p-2 w-full font-bold mb-2">Add Item</button>
            <button onclick="submitOrder()" class="neu-brutal bg-green-300 p-2 w-full font-bold">Submit Order</button>
        </div>
    </div>

    <script>
        let userId = localStorage.getItem('userId') || uuid.v4();
        localStorage.setItem('userId', userId);
        
        // Login handling
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            // Here you would typically validate against a server
            // For demo, we'll use a simple check
            if (username === 'demo' && password === 'password') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('attendanceSection').style.display = 'block';
                initCamera();
            } else {
                alert('Invalid credentials');
            }
        }

        // Initially only show login section
        document.getElementById('attendanceSection').style.display = 'none';
        document.getElementById('beatPlanSection').style.display = 'none';
        document.getElementById('orderSection').style.display = 'none';

        // Camera handling
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('camera').srcObject = stream;
            } catch (err) {
                console.error('Camera error:', err);
                alert('Unable to access camera');
            }
        }

        async function markAttendance() {
            const loading = document.getElementById('loadingScreen');
            loading.style.display = 'flex';

            const store = document.getElementById('storeSelect').value;
            if (!store) {
                alert('Please select a store');
                loading.style.display = 'none';
                return;
            }

            const canvas = document.getElementById('photoCanvas');
            const video = document.getElementById('camera');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/db', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer MmzDDEQcQjfzazAeqELxZWo2sF42',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        appSlug: 'sales-field-app',
                        action: 'create',
                        table: 'attendance',
                        data: {
                            store: store,
                            timestamp: new Date().toISOString(),
                            photo: canvas.toDataURL('image/jpeg')
                        }
                    })
                });

                const data = await response.json();
                if (!data.error) {
                    alert('Attendance marked successfully!');
                    document.getElementById('beatPlanSection').style.display = 'block';
                    document.getElementById('orderSection').style.display = 'block';
                } else {
                    alert('Error marking attendance');
                }
            } catch (err) {
                console.error('Attendance error:', err);
                alert('Error marking attendance');
            }

            loading.style.display = 'none';
        }

        function addBeatPlan() {
            const container = document.getElementById('beatPlanContainer');
            const div = document.createElement('div');
            div.className = 'beat-plan-item mb-4';
            div.innerHTML = `
                <input type="text" placeholder="Location" class="w-full p-2 mb-2 neu-brutal">
                <button class="neu-brutal bg-blue-300 p-2 w-full font-bold mb-2" onclick="toggleMeeting(this)">Start Meeting</button>
                <textarea placeholder="Meeting Outcome" class="w-full p-2 neu-brutal" style="display: none"></textarea>
            `;
            container.appendChild(div);
        }

        function toggleMeeting(btn) {
            const textarea = btn.nextElementSibling;
            if (btn.textContent === 'Start Meeting') {
                btn.textContent = 'End Meeting';
                btn.className = 'neu-brutal bg-red-300 p-2 w-full font-bold mb-2';
                textarea.style.display = 'none';
            } else {
                btn.textContent = 'Start Meeting';
                btn.className = 'neu-brutal bg-blue-300 p-2 w-full font-bold mb-2';
                textarea.style.display = 'block';
            }
        }

        function addOrderItem() {
            const container = document.getElementById('orderItems');
            const div = document.createElement('div');
            div.className = 'order-item mb-4';
            div.innerHTML = `
                <input type="text" placeholder="Item Name" class="w-full p-2 mb-2 neu-brutal">
                <input type="number" placeholder="Quantity" class="w-full p-2 neu-brutal">
            `;
            container.appendChild(div);
        }

        async function submitOrder() {
            const loading = document.getElementById('loadingScreen');
            loading.style.display = 'flex';

            const store = document.getElementById('orderStore').value;
            if (!store) {
                alert('Please select a store');
                loading.style.display = 'none';
                return;
            }

            const items = [];
            document.querySelectorAll('.order-item').forEach(item => {
                const itemName = item.querySelector('input[type="text"]').value;
                const quantity = item.querySelector('input[type="number"]').value;
                if (itemName && quantity) {
                    items.push({ item: itemName, quantity: parseInt(quantity) });
                }
            });

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/db', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer MmzDDEQcQjfzazAeqELxZWo2sF42',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        appSlug: 'sales-field-app',
                        action: 'create',
                        table: 'orders',
                        data: {
                            store: store,
                            items: items,
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                const data = await response.json();
                if (!data.error) {
                    alert('Order submitted successfully!');
                    document.getElementById('orderItems').innerHTML = `
                        <div class="order-item mb-4">
                            <input type="text" placeholder="Item Name" class="w-full p-2 mb-2 neu-brutal">
                            <input type="number" placeholder="Quantity" class="w-full p-2 neu-brutal">
                        </div>
                    `;
                } else {
                    alert('Error submitting order');
                }
            } catch (err) {
                console.error('Order submission error:', err);
                alert('Error submitting order');
            }

            loading.style.display = 'none';
        }
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>